Select images to print
================

``` r
knitr::opts_chunk$set(echo = TRUE)
library(glue)
library(magrittr)
library(stringr)
library(tidyverse)
```

## Prepare load\_data

``` r
load_data <- 
  list.files("../load_data_csv/", pattern = "load_data.csv", full.names = T, recursive = T)  %>%
  map_df(read_csv)

convert_to_s3_url <- function(pathname, filename)  {
  file.path(
      str_replace(pathname, 
              "/home/ubuntu/bucket", 
              "https://s3.amazonaws.com/imaging-platform"),
      filename
  )
  
}

channels <- c("DNA", "ER", "RNA", "AGP", "Mito")

for (channel in channels) {
  url_sym <- rlang::sym(str_c("URL_Orig", channel))
  
  path_sym <- rlang::sym(str_c("PathName_Orig", channel))
   
  file_sym <- rlang::sym(str_c("FileName_Orig", channel))
   
  load_data %<>% 
    mutate(!!url_sym := convert_to_s3_url((!!path_sym), (!!file_sym)))
  
}
```

## Get metadata

``` r
plates <- c("cmqtlpl1.5-31-2019-mt",
            "cmqtlpl261-2019-mt",
            "BR00106708",
            "BR00106709",
            "BR00107338",
            "BR00107339",
            "cmQTLplate7-7-22-20")

metadata <- 
  map_df(
    plates,
    function(plate) {
      read_csv(
        file.path("profiles", glue("{plate}_augmented.csv")),
        col_types = cols_only(
          Metadata_Plate = "c",
          Metadata_Well = "c",
          Metadata_Assay_Plate_Barcode = "c",
          Metadata_Plate_Map_Name = "c",
          Metadata_well_position = "c",
          Metadata_plating_density = "c",
          Metadata_line_ID = "c"
        )
      ) %>%
        distinct()
    }
  )
```

## Confirm that the plating density is the same across all lines

``` r
metadata %>% distinct(Metadata_plating_density)
```

    ## # A tibble: 1 x 1
    ##   Metadata_plating_density
    ##   <chr>                   
    ## 1 10000

## Select cell lines to print

``` r
cell_lines <-
  tibble::tribble(
    ~Metadata_line_ID, ~Metadata_Plate,
    "12","cmqtlpl1.5-31-2019-mt",
    "29","cmqtlpl1.5-31-2019-mt",
    "30","cmqtlpl1.5-31-2019-mt",
    "32","cmqtlpl1.5-31-2019-mt",
    "112","BR00107338",
    "113","BR00106709",
    "125","BR00106709",
    "136","BR00106709",
    "153","BR00106708",
    "155","BR00106708",
    "158","BR00106708",
    "181","BR00106708",
    "195","BR00107339",
    "206","BR00107339",
    "213","BR00107339",
    "214","BR00107339",
    "215","BR00107339",
    "222","BR00107339",
    "227","BR00107339",
    "233","BR00107338",
    "238","BR00107338",
    "248","BR00107338",
    "255","BR00107338",
    "260","BR00107338",
    "265","BR00107338",
    "277","cmQTLplate7-7-22-20"
  )

metadata %<>% inner_join(cell_lines)
```

    ## Joining, by = c("Metadata_Plate", "Metadata_line_ID")

## Sample one well per cell line

``` r
# set.seed(5)
# 
# metadata_sampled <-
#   metadata %>%
#   group_by(Metadata_line_ID) %>%
#   sample_n(1) %>%
#   ungroup()

metadata_sampled <-
  metadata
```

## Select a fixed field (a.k.a site)

``` r
#fieldIDs <- c(3, 5)
#
fieldIDs <- c(1, 2, 3, 4, 5, 6, 7, 8, 9)
```

## Select images to be printed

``` r
filenames_header <- paste0("FileName_Orig", channels)

images <- 
  load_data %>%
  select(Metadata_Plate, Metadata_Well, Metadata_Row, Metadata_FieldID, matches("^URL_"), one_of(filenames_header)) %>%
  inner_join(metadata_sampled, by = c("Metadata_Plate", "Metadata_Well")) %>%
  filter(Metadata_FieldID %in% fieldIDs) %>%
  select(matches("^Metadata"), matches("^URL"), matches("^FileName_Orig"))
```

``` r
batch_plate <-
  tribble(
    ~Metadata_Batch, ~Metadata_Plate,
    "2020_07_22_Batch7", "cmQTLplate7-7-22-20",
    "2019_09_06_Batch5", "BR00107338",
    "2019_09_06_Batch5", "BR00107339",
    "2019_08_15_Batch4", "BR00106708",
    "2019_08_15_Batch4", "BR00106709",
    "2019_06_10_Batch3", "cmqtlpl261-2019-mt",
    "2019_06_10_Batch3", "cmqtlpl1.5-31-2019-mt"
  )

prefix <- "https://s3.amazonaws.com/imaging-platform/projects/2018_06_05_cmQTL"

# s3://imaging-platform/projects/2018_06_05_cmQTL/workspace/analysis/2019_06_10_Batch3/PLATE/analysis/PLATE-WELL-SITE/outlines/WELL_sSITE--nuclei_outlines.png 
# s3://imaging-platform/projects/2018_06_05_cmQTL/workspace/analysis/2019_06_10_Batch3/PLATE/analysis/PLATE-WELL-SITE/outlines/WELL_sSITE--cell_outlines.png.

nuclei_suffix <- "nuclei_outlines.png"
cell_suffix <- "cell_outlines.png"

images %<>%
  inner_join(batch_plate) %>%
  mutate(URL_nuclei_outlines = 
           file.path(
             prefix,
             "workspace",
             "analysis",
             Metadata_Batch,
             Metadata_Plate,
             paste(Metadata_Plate, Metadata_Well, Metadata_FieldID, sep = "-"),
             glue("{Metadata_Well}_s{Metadata_FieldID}--{nuclei_suffix}")
           )
         ) %>%
  mutate(URL_cell_outlines = 
           file.path(
             prefix,
             "workspace",
             "analysis",
             Metadata_Batch,
             Metadata_Plate,
             "analysis",
             paste(Metadata_Plate, Metadata_Well, Metadata_FieldID, sep = "-"),
             "outlines",
             glue("{Metadata_Well}_s{Metadata_FieldID}--{cell_suffix}")
           )
         )
```

    ## Joining, by = "Metadata_Plate"

``` r
images_pivoted <-
  images %>%
  select(Metadata_Plate,  Metadata_Well, matches("^URL_")) %>%
  gather(Metadata_Channel, URL, -Metadata_Plate, -Metadata_Well) %>%
  mutate(filename = basename(URL)) %>%
  select(Metadata_Plate, Metadata_Well, Metadata_Channel, filename, URL)

images_pivoted %>% 
  write_csv("data/sample_images.csv")
```

``` r
images %>%
  select(matches("^Metadata"),  matches("^FileName_Orig")) %>%
  write_csv("data/sample_images_metadata.csv")
```

Run this on command line to download the images:

``` sh
IMAGE_DIR=/tmp/cmqtl

mkdir -p $IMAGE_DIR

cut -d"," -f1 data/sample_images.csv | grep -v Metadata_Plate| sort -u > /tmp/plates.txt

parallel -a /tmp/plates.txt --no-run-if-empty mkdir -p $IMAGE_DIR/{} 

parallel \
 --header ".*\n" \
 -C "," \
 -a data/sample_images.csv \
 --eta \
 --joblog ${IMAGE_DIR}/download.log \
 wget -q -O ${IMAGE_DIR}/{1}/{4} {5}
  
```
